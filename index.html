import React, { useState, useEffect } from 'react';
import { 
  Target, TrendingUp, Users, ChevronRight, BarChart3, Plus, 
  LayoutDashboard, ListTodo, CheckCircle2, AlertCircle, Award, 
  BookOpen, PieChart, Save, RefreshCw, Database, ExternalLink, 
  User, MessageSquare, Settings, Trash2, X, Check, FileText,
  ShieldCheck, LogOut, Briefcase, Group, Activity, Globe,
  Cpu, Zap, Beaker, Edit3, Layers, Calendar
} from 'lucide-react';

const App = () => {
  // --- Configuración e Integración ---
  const DEFAULT_SHEET_URL = "https://script.google.com/macros/s/AKfycbz9hTBQlGDWQIWHFUvDookbqzc4YSYu2cCY997YvwgksQoWKkl_Hx7-58dYBv3-yGl9zQ/exec";

  // --- Estados Principales ---
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [isSaving, setIsSaving] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [sheetUrl, setSheetUrl] = useState(DEFAULT_SHEET_URL);
  const [lastSync, setLastSync] = useState("Pendiente");
  const [showNotification, setShowNotification] = useState(null);
  
  // Estado para el modal de edición/creación
  const [modalState, setModalState] = useState({ show: false, project: null });

  // --- Datos Maestros ---
  const [squads] = useState([
    { id: 'S1', name: 'Squad Alpha (Cori Talks)' },
    { id: 'S2', name: 'Squad Beta (LMS Optimization)' },
    { id: 'S3', name: 'Squad Gamma (Innovación)' }
  ]);

  const [roles] = useState(['Super Admin', 'PO', 'Scrum Master', 'Developer']);

  // --- Proyectos (Estructura Jerárquica) ---
  const [projects, setProjects] = useState([
    {
      id: 'P1',
      squadId: 'S1',
      name: "Cori Talks",
      description: "Espacio diseñado para conectar, aprender e inspirar a través del conocimiento de los colaboradores.",
      participants: [{ name: 'Juan PO', role: 'PO' }],
      objectives: [
        {
          id: 'O1',
          title: "Fortalecer la cultura de aprendizaje colaborativo",
          krs: [
            { id: 'KR1.1', definition: '40% colaboradores conectados trimestralmente', target: 40, current: 28, owner: 'Gestión Humana', deadline: '2025-06-30' },
            { id: 'KR1.2', definition: 'Alcanzar 85% de satisfacción en encuestas', target: 85, current: 80, owner: 'Comunicaciones', deadline: '2025-06-30' }
          ]
        },
        {
          id: 'O2',
          title: "Convertir CoriTalks en fuente estructurada de conocimiento",
          krs: [
            { id: 'KR2.1', definition: 'Publicar el 100% de sesiones en el LMS', target: 100, current: 100, owner: 'Sistemas', deadline: '2025-04-30' }
          ]
        }
      ]
    }
  ]);

  // --- Cálculos de Progreso ---
  const calculateObjectiveProgress = (objective) => {
    if (!objective.krs || objective.krs.length === 0) return 0;
    const total = objective.krs.reduce((acc, kr) => acc + (Math.min(kr.current / kr.target, 1)), 0);
    return Math.round((total / objective.krs.length) * 100);
  };

  const calculateProjectProgress = (project) => {
    if (!project.objectives || project.objectives.length === 0) return 0;
    const total = project.objectives.reduce((acc, obj) => acc + calculateObjectiveProgress(obj), 0);
    return Math.round(total / project.objectives.length);
  };

  const calculateGlobalProgress = () => {
    const filtered = getFilteredProjects();
    if (filtered.length === 0) return 0;
    const total = filtered.reduce((acc, p) => acc + calculateProjectProgress(p), 0);
    return Math.round(total / filtered.length);
  };

  // --- Lógica de Negocio ---
  const notify = (msg, type = 'success') => {
    setShowNotification({ msg, type });
    setTimeout(() => setShowNotification(null), 3000);
  };

  const getFilteredProjects = () => {
    return user?.role === 'Super Admin' 
      ? projects 
      : projects.filter(p => p.squadId === user?.squadId);
  };

  const handleSaveProject = (updatedProject) => {
    setProjects(prev => {
      const exists = prev.find(p => p.id === updatedProject.id);
      if (exists) {
        return prev.map(p => p.id === updatedProject.id ? updatedProject : p);
      }
      return [...prev, { ...updatedProject, id: `P${prev.length + 1}` }];
    });
    setModalState({ show: false, project: null });
    notify("Proyecto actualizado correctamente");
  };

  // --- Robot de Pruebas ---
  const runTestRobot = () => {
    setIsLoading(true);
    setTimeout(() => {
      const robotProj = {
        id: `PROBOT-${Date.now()}`,
        squadId: 'S3',
        name: "IA Generativa en Risaralda",
        description: "Proyecto piloto para implementar asistentes de IA en procesos administrativos.",
        participants: [{ name: 'Robot Admin', role: 'Developer' }],
        objectives: [
          {
            id: 'O1',
            title: "Optimización de tiempos de respuesta",
            krs: [
              { id: 'KR1.1', definition: 'Reducir en 20% el tiempo de trámites', target: 20, current: 5, owner: 'Innovación', deadline: '2025-12-31' }
            ]
          }
        ]
      };
      setProjects([...projects, robotProj]);
      setIsLoading(false);
      notify("Robot: Proyecto de IA creado");
    }, 1000);
  };

  // --- Vistas ---
  if (!user) return <LoginView roles={roles} squads={squads} onLogin={(u) => { setUser(u); notify(`Bienvenido, ${u.name}`); }} />;

  return (
    <div className="flex h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden">
      {showNotification && <Notification data={showNotification} />}
      
      {/* Sidebar */}
      <aside className="w-72 bg-slate-950 text-white flex flex-col shrink-0">
        <div className="p-8 border-b border-slate-900">
          <div className="flex items-center gap-3 mb-6">
            <Target size={24} className="text-cyan-400" />
            <h1 className="text-2xl font-black italic tracking-tight uppercase">Cori<span className="text-cyan-400 font-light">Talks</span></h1>
          </div>
          <div className="p-4 bg-slate-900/50 rounded-2xl border border-slate-800 flex items-center gap-3">
            <div className="w-10 h-10 bg-cyan-600 rounded-xl flex items-center justify-center font-black text-sm">{user.name.substring(0,2).toUpperCase()}</div>
            <div>
              <p className="text-sm font-bold truncate leading-none mb-1">{user.name}</p>
              <p className="text-[10px] text-cyan-500 font-black uppercase tracking-tighter">{user.role}</p>
            </div>
          </div>
        </div>
        <nav className="flex-1 p-6 space-y-2">
          {[
            { id: 'dashboard', label: 'Dashboard Global', icon: LayoutDashboard },
            { id: 'projects', label: 'Mis Proyectos', icon: Briefcase },
            { id: 'sync', label: 'Google Sheets', icon: Database },
          ].map(item => (
            <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all ${activeTab === item.id ? 'bg-cyan-600 text-white shadow-lg shadow-cyan-900/20' : 'text-slate-500 hover:bg-slate-900 hover:text-white'}`}>
              <item.icon size={18} /> <span className="text-sm font-bold">{item.label}</span>
            </button>
          ))}
        </nav>
        <div className="p-6 border-t border-slate-900">
          <button onClick={() => setUser(null)} className="w-full flex items-center justify-center gap-2 text-slate-600 hover:text-red-400 text-[10px] font-black uppercase transition-colors">
            <LogOut size={14} /> Cerrar Sesión
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 overflow-y-auto p-10 bg-[#F8FAFC]">
        <div className="max-w-6xl mx-auto">
          {activeTab === 'dashboard' && <DashboardView projects={getFilteredProjects()} calculateProgress={calculateProjectProgress} globalProgress={calculateGlobalProgress()} squads={squads} user={user} />}
          {activeTab === 'projects' && <ProjectsView projects={getFilteredProjects()} squads={squads} user={user} onEdit={(p) => setModalState({ show: true, project: p })} onAdd={() => setModalState({ show: true, project: null })} calculateProgress={calculateProjectProgress} />}
          {activeTab === 'sync' && <SyncView sheetUrl={sheetUrl} setSheetUrl={setSheetUrl} lastSync={lastSync} onRunRobot={runTestRobot} onClearRobot={() => setProjects(prev => prev.filter(p => !p.id.startsWith('PROBOT')))} />}
        </div>
      </main>

      {/* Modal de Edición de Proyecto (EL CORAZÓN DE LA HERRAMIENTA) */}
      {modalState.show && (
        <ProjectModal 
          project={modalState.project} 
          squads={squads} 
          onClose={() => setModalState({ show: false, project: null })} 
          onSave={handleSaveProject} 
        />
      )}
    </div>
  );
};

// --- SUBCOMPONENTES ---

const LoginView = ({ roles, squads, onLogin }) => {
  const [form, setForm] = useState({ email: '', role: 'PO', squadId: 'S1' });
  return (
    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6 font-sans">
      <div className="max-w-md w-full bg-slate-900 rounded-[2.5rem] border border-slate-800 p-10 shadow-2xl animate-in zoom-in-95 duration-500">
        <div className="text-center mb-10">
          <div className="bg-cyan-500 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-cyan-500/20">
            <Target size={32} className="text-white" />
          </div>
          <h1 className="text-3xl font-black text-white italic tracking-tighter uppercase leading-none">Cori<span className="text-cyan-400 font-light">Talks</span></h1>
          <p className="text-slate-500 text-sm mt-3 font-medium">Plataforma Estratégica OKR</p>
        </div>
        <form onSubmit={(e) => { e.preventDefault(); onLogin({ name: form.email.split('@')[0], ...form }); }} className="space-y-6">
          <input type="email" required className="w-full bg-slate-800 border border-slate-700 rounded-2xl px-5 py-4 text-white focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="correo@comfamiliar.com" value={form.email} onChange={e => setForm({...form, email: e.target.value})} />
          <div className="grid grid-cols-2 gap-4">
            <select className="bg-slate-800 border border-slate-700 rounded-2xl px-4 py-4 text-white text-xs outline-none" value={form.role} onChange={e => setForm({...form, role: e.target.value})}>
              {roles.map(r => <option key={r} value={r}>{r}</option>)}
            </select>
            {form.role !== 'Super Admin' && (
              <select className="bg-slate-800 border border-slate-700 rounded-2xl px-4 py-4 text-white text-xs outline-none" value={form.squadId} onChange={e => setForm({...form, squadId: e.target.value})}>
                {squads.map(s => <option key={s.id} value={s.id}>{s.name.split(' ')[1]}</option>)}
              </select>
            )}
          </div>
          <button className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-black py-4 rounded-2xl transition-all shadow-xl shadow-cyan-900/20 active:scale-95">Ingresar al Dashboard</button>
        </form>
      </div>
    </div>
  );
};

const DashboardView = ({ projects, globalProgress, squads, user, calculateProgress }) => (
  <div className="space-y-8 animate-in fade-in duration-500">
    <header className="flex justify-between items-end">
      <div>
        <h2 className="text-4xl font-black text-slate-900 tracking-tight">Tablero Ejecutivo</h2>
        <p className="text-slate-500 font-medium mt-2 italic">Análisis estratégico para <span className="text-cyan-600 font-bold underline underline-offset-4">{user.role === 'Super Admin' ? 'Toda la Organización' : squads.find(s=>s.id===user.squadId)?.name}</span></p>
      </div>
      <div className="bg-white px-8 py-5 rounded-[2.5rem] border border-slate-100 shadow-sm flex items-center gap-6">
        <div className="relative w-16 h-16 flex items-center justify-center">
            <svg className="w-full h-full transform -rotate-90">
                <circle cx="32" cy="32" r="28" fill="transparent" stroke="#f1f5f9" strokeWidth="6" />
                <circle cx="32" cy="32" r="28" fill="transparent" stroke="#0ea5e9" strokeWidth="6" strokeDasharray={175.9} strokeDashoffset={175.9 - (175.9 * globalProgress) / 100} strokeLinecap="round" className="transition-all duration-1000" />
            </svg>
            <span className="absolute font-black text-lg text-slate-800">{globalProgress}%</span>
        </div>
        <div>
          <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1">CUMPLIMIENTO<br/>ESTRATÉGICO</p>
        </div>
      </div>
    </header>

    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
      {[
        { label: 'Proyectos', value: projects.length, icon: Activity, color: 'text-blue-600', bg: 'bg-blue-100' },
        { label: 'Objetivos', value: projects.reduce((acc,p)=>acc+p.objectives.length, 0), icon: Layers, color: 'text-indigo-600', bg: 'bg-indigo-100' },
        { label: 'KRs Activos', value: projects.reduce((acc,p)=>acc+p.objectives.reduce((a,o)=>a+o.krs.length,0), 0), icon: CheckCircle2, color: 'text-emerald-600', bg: 'bg-emerald-100' },
        { label: 'Impacto', value: 'Alto', icon: Zap, color: 'text-orange-600', bg: 'bg-orange-100' }
      ].map((stat, i) => (
        <div key={i} className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
          <div className={`w-10 h-10 rounded-xl ${stat.bg} ${stat.color} flex items-center justify-center mb-4 shadow-inner`}><stat.icon size={20} /></div>
          <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{stat.label}</p>
          <p className="text-2xl font-black text-slate-900">{stat.value}</p>
        </div>
      ))}
    </div>

    <div className="bg-white rounded-[3rem] p-10 border border-slate-200 shadow-sm relative overflow-hidden">
      <div className="absolute top-0 right-0 p-10 opacity-5 pointer-events-none"><PieChart size={150} /></div>
      <h3 className="text-xl font-black text-slate-900 mb-8 flex items-center gap-3"><BarChart3 size={24} className="text-cyan-600" /> Comparativa de Avance</h3>
      <div className="space-y-10 relative z-10">
        {projects.map(p => (
          <div key={p.id} className="group">
            <div className="flex justify-between items-end mb-3">
              <div>
                <p className="text-[10px] font-black text-cyan-600 uppercase tracking-widest mb-1">{p.id} · {squads.find(s=>s.id===p.squadId)?.name.split(' ')[1]}</p>
                <h4 className="text-lg font-bold text-slate-800">{p.name}</h4>
              </div>
              <span className="text-2xl font-black text-slate-900">{calculateProgress(p)}%</span>
            </div>
            <div className="w-full bg-slate-100 h-4 rounded-full overflow-hidden shadow-inner">
              <div className="bg-gradient-to-r from-cyan-600 to-cyan-400 h-full transition-all duration-1000" style={{ width: `${calculateProgress(p)}%` }}></div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
);

const ProjectsView = ({ projects, squads, user, onEdit, onAdd, calculateProgress }) => (
  <div className="space-y-8 animate-in slide-in-from-right-4 duration-500">
    <header className="flex justify-between items-center">
      <div>
        <h2 className="text-4xl font-black text-slate-900 tracking-tight italic uppercase">Estrategia & Squads</h2>
        <p className="text-slate-500 font-medium">Gestión jerárquica de proyectos, objetivos y resultados.</p>
      </div>
      {(user.role === 'PO' || user.role === 'Super Admin') && (
        <button onClick={onAdd} className="bg-slate-900 text-white px-8 py-5 rounded-[2rem] font-black text-xs uppercase tracking-widest flex items-center gap-3 hover:bg-cyan-600 transition-all shadow-xl shadow-slate-900/10">
          <Plus size={18} /> Nuevo Proyecto
        </button>
      )}
    </header>

    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
      {projects.map(p => (
        <div key={p.id} className="bg-white rounded-[3rem] border border-slate-200 overflow-hidden hover:shadow-2xl transition-all group relative">
          <button onClick={() => onEdit(p)} className="absolute top-8 right-8 p-4 bg-slate-50 text-slate-400 hover:text-cyan-600 hover:bg-cyan-50 rounded-2xl transition-all shadow-sm group-hover:bg-cyan-600 group-hover:text-white">
            <Edit3 size={18} />
          </button>
          
          <div className="p-10 border-b border-slate-50 bg-slate-50/30">
            <span className="bg-white border border-slate-200 px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest text-slate-500 shadow-sm inline-block mb-6">
              {squads.find(s=>s.id===p.squadId)?.name}
            </span>
            <h3 className="text-3xl font-black text-slate-900 mb-4 pr-12">{p.name}</h3>
            <p className="text-sm text-slate-500 leading-relaxed font-medium italic">"{p.description}"</p>
          </div>
          
          <div className="p-10 space-y-6">
            <div>
              <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">OBJETIVOS ESTRATÉGICOS ({p.objectives.length})</p>
              <div className="space-y-4">
                {p.objectives.map((obj, i) => (
                    <div key={i} className="bg-slate-50/50 p-4 rounded-2xl border border-slate-100">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-bold text-slate-800 line-clamp-1">{obj.title}</span>
                            <span className="text-[10px] font-black text-cyan-600">{obj.krs.length} KRs</span>
                        </div>
                        <div className="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden">
                            <div className="bg-cyan-500 h-full" style={{ width: `${projects.find(proj => proj.id === p.id).objectives.find(o => o.id === obj.id).krs.reduce((acc, kr) => acc + (kr.current / kr.target), 0) / (obj.krs.length || 1) * 100}%` }}></div>
                        </div>
                    </div>
                ))}
              </div>
            </div>
            <div className="pt-6 border-t border-slate-100 flex justify-between items-center">
                <div className="flex -space-x-3">
                    {p.participants.map((part, i) => (
                    <div key={i} title={part.name} className="w-10 h-10 rounded-2xl bg-slate-900 border-2 border-white flex items-center justify-center text-[10px] font-bold text-white shadow-md">
                        {part.name.substring(0,1).toUpperCase()}
                    </div>
                    ))}
                </div>
                <div className="text-right">
                    <p className="text-[10px] font-black text-slate-400 uppercase mb-1">PROGRESO TOTAL</p>
                    <p className="text-3xl font-black text-cyan-600">{calculateProgress(p)}%</p>
                </div>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
);

const ProjectModal = ({ project, squads, onClose, onSave }) => {
  const [formData, setFormData] = useState(project || {
    id: '',
    name: '',
    description: '',
    squadId: 'S1',
    participants: [{ name: 'Nuevo Usuario', role: 'PO' }],
    objectives: []
  });

  const [activeObjIndex, setActiveObjIndex] = useState(null);

  const addObjective = () => {
    setFormData({
      ...formData,
      objectives: [
        ...formData.objectives,
        { id: `O${formData.objectives.length + 1}`, title: 'Nuevo Objetivo Estratégico', krs: [] }
      ]
    });
    setActiveObjIndex(formData.objectives.length);
  };

  const addKR = (objIndex) => {
    const newObjectives = [...formData.objectives];
    newObjectives[objIndex].krs.push({
      id: `KR${objIndex + 1}.${newObjectives[objIndex].krs.length + 1}`,
      definition: 'Nuevo Resultado Clave',
      target: 100,
      current: 0,
      owner: 'Asignado',
      deadline: '2025-12-31'
    });
    setFormData({ ...formData, objectives: newObjectives });
  };

  const updateKR = (objIndex, krIndex, field, value) => {
    const newObjectives = [...formData.objectives];
    newObjectives[objIndex].krs[krIndex][field] = value;
    setFormData({ ...formData, objectives: newObjectives });
  };

  const deleteObjective = (index) => {
    setFormData({ ...formData, objectives: formData.objectives.filter((_, i) => i !== index) });
    setActiveObjIndex(null);
  };

  return (
    <div className="fixed inset-0 z-[100] bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-6 overflow-hidden animate-in fade-in duration-300">
      <div className="bg-white w-full max-w-5xl h-[90vh] rounded-[3.5rem] shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95">
        
        {/* Header Modal */}
        <div className="p-10 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div>
                <h2 className="text-3xl font-black text-slate-900 tracking-tight italic">{project ? 'Editar Proyecto' : 'Inaugurar Proyecto'}</h2>
                <p className="text-slate-500 font-medium">Configura los objetivos y resultados clave del squad.</p>
            </div>
            <button onClick={onClose} className="p-4 bg-white hover:bg-slate-100 rounded-3xl text-slate-400 border border-slate-200 transition-all"><X size={24} /></button>
        </div>

        <div className="flex-1 overflow-y-auto p-10 custom-scrollbar">
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-10">
                {/* Lado Izquierdo: Datos Generales */}
                <div className="lg:col-span-4 space-y-6">
                    <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Nombre del Proyecto</label>
                        <input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 outline-none focus:ring-4 focus:ring-cyan-500/10 font-bold text-lg" placeholder="Nombre..." />
                    </div>
                    <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Reseña del Proyecto</label>
                        <textarea value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 outline-none focus:ring-4 focus:ring-cyan-500/10 font-medium h-32 leading-relaxed" placeholder="Reseña..."></textarea>
                    </div>
                    <div>
                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Squad Responsable</label>
                        <select value={formData.squadId} onChange={e => setFormData({...formData, squadId: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 font-bold text-sm outline-none">
                            {squads.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                    </div>
                </div>

                {/* Lado Derecho: Objetivos y KRs */}
                <div className="lg:col-span-8 space-y-8">
                    <div className="flex justify-between items-center mb-4">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">OBJETIVOS Y RESULTADOS CLAVE</p>
                        <button onClick={addObjective} className="bg-cyan-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2 hover:bg-cyan-700 transition-colors">
                            <Plus size={14} /> Agregar Objetivo
                        </button>
                    </div>

                    <div className="space-y-6">
                        {formData.objectives.map((obj, oIdx) => (
                            <div key={oIdx} className="bg-slate-50 border border-slate-200 rounded-[2.5rem] overflow-hidden group">
                                <div className="p-6 bg-white border-b border-slate-100 flex items-center gap-4">
                                    <div className="w-10 h-10 bg-slate-900 rounded-2xl flex items-center justify-center text-white font-black text-xs">O{oIdx+1}</div>
                                    <input 
                                        type="text" 
                                        value={obj.title} 
                                        onChange={e => {
                                            const newObjs = [...formData.objectives];
                                            newObjs[oIdx].title = e.target.value;
                                            setFormData({...formData, objectives: newObjs});
                                        }}
                                        className="flex-1 font-black text-slate-800 bg-transparent outline-none focus:text-cyan-600 transition-colors"
                                    />
                                    <button onClick={() => deleteObjective(oIdx)} className="p-2 text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"><Trash2 size={18} /></button>
                                </div>
                                
                                <div className="p-6 space-y-4">
                                    <div className="flex justify-between items-center">
                                        <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">RESULTADOS CLAVE (KRs)</span>
                                        <button onClick={() => addKR(oIdx)} className="text-cyan-600 text-[9px] font-black uppercase tracking-widest flex items-center gap-1 hover:underline">
                                            <Plus size={12} /> Agregar KR
                                        </button>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        {obj.krs.map((kr, kIdx) => (
                                            <div key={kIdx} className="grid grid-cols-12 gap-3 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm items-center">
                                                <div className="col-span-1 text-[10px] font-black text-slate-300">{kr.id}</div>
                                                <div className="col-span-5">
                                                    <input type="text" value={kr.definition} onChange={e => updateKR(oIdx, kIdx, 'definition', e.target.value)} className="w-full text-xs font-bold text-slate-700 outline-none" placeholder="Definición del KR" />
                                                </div>
                                                <div className="col-span-2">
                                                    <div className="flex items-center gap-1 bg-slate-50 px-2 py-1 rounded-lg">
                                                        <input type="number" value={kr.current} onChange={e => updateKR(oIdx, kIdx, 'current', parseFloat(e.target.value))} className="w-full text-[10px] font-black text-slate-800 bg-transparent text-center" />
                                                        <span className="text-[9px] text-slate-400">/</span>
                                                        <input type="number" value={kr.target} onChange={e => updateKR(oIdx, kIdx, 'target', parseFloat(e.target.value))} className="w-full text-[10px] font-black text-slate-400 bg-transparent text-center" />
                                                    </div>
                                                </div>
                                                <div className="col-span-3">
                                                    <input type="text" value={kr.owner} onChange={e => updateKR(oIdx, kIdx, 'owner', e.target.value)} className="w-full text-[9px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg" placeholder="Responsable" />
                                                </div>
                                                <div className="col-span-1 flex justify-end">
                                                    <button onClick={() => {
                                                        const newObjs = [...formData.objectives];
                                                        newObjs[oIdx].krs = newObjs[oIdx].krs.filter((_, idx) => idx !== kIdx);
                                                        setFormData({...formData, objectives: newObjs});
                                                    }} className="text-slate-300 hover:text-red-500"><Trash2 size={14} /></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>

        {/* Footer Modal */}
        <div className="p-10 border-t border-slate-100 bg-slate-50/50 flex gap-4">
            <button onClick={() => onSave(formData)} className="flex-1 bg-slate-900 text-white font-black py-6 rounded-[2rem] uppercase text-xs tracking-[0.2em] shadow-2xl hover:bg-cyan-600 transition-all flex items-center justify-center gap-3 active:scale-[0.98]">
                <Check size={20} /> Guardar Estrategia
            </button>
            <button onClick={onClose} className="px-12 border border-slate-200 font-black py-6 rounded-[2rem] uppercase text-xs tracking-[0.2em] hover:bg-white transition-all">Cancelar</button>
        </div>
      </div>
    </div>
  );
};

const SyncView = ({ sheetUrl, setSheetUrl, lastSync, onRunRobot, onClearRobot }) => (
  <div className="max-w-4xl mx-auto animate-in zoom-in-95 duration-500 space-y-8">
    <div className="bg-white p-12 rounded-[3.5rem] border border-slate-200 shadow-2xl relative overflow-hidden">
      <div className="absolute top-0 right-0 p-12 opacity-5 pointer-events-none"><Database size={200} /></div>
      <div className="flex items-center gap-6 mb-12 relative z-10">
        <div className="p-5 bg-cyan-100 text-cyan-600 rounded-[2rem] shadow-inner"><Database size={48} /></div>
        <div>
          <h2 className="text-3xl font-black text-slate-900 tracking-tight">Infraestructura Cloud</h2>
          <p className="text-slate-500 font-medium italic">Sincronización con Google Sheets API.</p>
        </div>
      </div>
      <div className="space-y-10 relative z-10">
        <div className="bg-slate-50 p-10 rounded-[2.5rem] border border-slate-200">
          <label className="block text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">URL del Script de Google</label>
          <div className="flex gap-4">
            <input type="text" value={sheetUrl} onChange={e => setSheetUrl(e.target.value)} className="flex-1 bg-white border border-slate-200 rounded-2xl px-6 py-4 text-xs font-mono text-slate-600 focus:ring-4 focus:ring-cyan-500/10 outline-none" />
            <button className="bg-slate-900 text-white px-8 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-cyan-600 flex items-center gap-2">Vincular</button>
          </div>
          <p className="mt-4 text-[10px] text-slate-400 font-bold uppercase tracking-tighter">ÚLTIMA SINCRONIZACIÓN: <span className="text-cyan-600">{lastSync}</span></p>
        </div>
        <div className="border-t border-slate-100 pt-10">
          <div className="flex items-center gap-3 mb-6"><Cpu className="text-cyan-500" /><h3 className="text-xl font-black text-slate-900">Laboratorio OKR</h3></div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onClick={onRunRobot} className="flex items-center justify-between p-8 bg-cyan-50 border border-cyan-100 rounded-[2.5rem] hover:bg-cyan-100 transition-all group">
              <div className="text-left"><p className="text-sm font-black text-cyan-700 uppercase tracking-widest">Ejecutar Robot</p><p className="text-[10px] text-cyan-600 font-bold uppercase mt-1">Simular Inyectar Datos</p></div>
              <Zap size={24} className="text-cyan-500 group-hover:scale-125 transition-transform" />
            </button>
            <button onClick={onClearRobot} className="flex items-center justify-between p-8 bg-red-50 border border-red-100 rounded-[2.5rem] hover:bg-red-100 transition-all group">
              <div className="text-left"><p className="text-sm font-black text-red-700 uppercase tracking-widest">Limpiar Laboratorio</p><p className="text-[10px] text-red-600 font-bold uppercase mt-1">Reiniciar Entorno</p></div>
              <Trash2 size={24} className="text-red-500 group-hover:scale-125 transition-transform" />
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
);

const Notification = ({ data }) => (
    <div className={`fixed top-6 right-6 z-[200] px-8 py-5 rounded-[2rem] shadow-2xl border flex items-center gap-4 animate-in slide-in-from-right-10 ${data.type === 'error' ? 'bg-red-50 text-red-700 border-red-100' : 'bg-white text-slate-800 border-slate-100'}`}>
        {data.type === 'error' ? <AlertCircle size={20} className="text-red-500" /> : <CheckCircle2 size={20} className="text-emerald-500" />}
        <p className="font-black text-sm uppercase tracking-tighter">{data.msg}</p>
    </div>
);

export default App;
